{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile{% endblock %}

{% block content %}
<style>
    @font-face {
        font-family: 'MavenPro';
        src: url("{% static 'fonts/MavenPro-Regular.ttf' %}") format('truetype');
    }

        .container {
        display: flex;
        min-height: 100vh;
        font-family: 'MavenPro', sans-serif;
    }

    .sidebar {
        width: 240px;
        background-color: #ffffff;
        padding: 40px 20px;
        border-right: 1px solid #ddd;
    }

    .sidebar ul {
        list-style: none;
        padding: 0;
    }

    .sidebar li {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
        font-size: 18px;
    }

    .sidebar li img {
        width: 24px;
        height: 24px;
        margin-right: 12px;
    }

    .sidebar li span a {
        color: #23194f;
        font-weight: 500;
        font-size: 16px;
        text-decoration: none;
    }

    .sidebar li span a:hover {
        color: #3a2d7c;
    }

    /* ACTIVE STATE */
    .sidebar li.active {
        background: #d9e8ff;          
        border-radius: 8px;            
        padding: 10px;
    }

    .sidebar li.active a {
        color: #1a73e8;                
        font-weight: 700;               
    }

    .main {
        flex: 1;
        padding: 60px;
        background-color: #f9f9f9;
    }

    .profile-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }

    .profile-info {
        display: flex;
        flex-direction: column;
    }

    .profile-img {
        width: 65px;
        height: 65px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
    }

    .edit-picture-btn {
        font-size: 14px;
        color: #4A90E2;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 4px;
    }

    .username {
        font-size: 24px;
        font-weight: bold;
        color: #23194f;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        margin-bottom: 6px;
        font-size: 14px;
        font-weight: 600;
        color: #555;
    }

    .form-group input,
    .form-group select {
        padding: 12px 14px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: #fff;
    }

    .form-group.full-width {
        grid-column: span 2;
    }

    .update-btn {
        background-color: #4CAF50;
        color: white;
        padding: 10px 16px;
        margin-top: 20px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        max-width: 300px;
    }

    .update-btn:hover {
        background-color: #45a049;
    }
    .request-admin-btn {
        background-color: #fbbf24;
        color: white;
        padding: 8px 12px;
        font-size: 14px;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
        width: auto;
        max-width: 220px;
        margin-top: 10px;
    }

    .request-admin-btn:hover {
        background-color: #f59e0b;
        transform: translateY(-2px);
    }

    .request-admin-btn:active {
        background-color: #eab308;
        transform: translateY(0);
    }

    .request-admin-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.5);
    }
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #ccc;
        }

        .main {
            padding: 30px;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .update-btn {
            width: auto;
            margin: 0 auto;
        }
    }
</style>
<div class="container">
    <aside class="sidebar">
        <ul>
            <li class="{% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
        <img src="{% static 'images/profile-user.png' %}" alt="Profile Icon">
        <span><a href="{% url 'profile' %}">Profile</a></span>
    </li>
    <li class="{% if request.resolver_match.url_name == 'mybookings' %}active{% endif %}">
        <img src="{% static 'images/open-book.png' %}" alt="Bookings Icon">
        <span><a href="{% url 'mybookings' %}">My Bookings</a></span>
    </li>
    <li class="{% if request.resolver_match.url_name == 'history' %}active{% endif %}">
        <img src="{% static 'images/history.png' %}" alt="History Icon">
        <span><a href="{% url 'history' %}">History</a></span>
    </li>
    <li>
        <img src="{% static 'images/logout.png' %}" alt="Logout Icon">
        <span><a href="javascript:void(0);" onclick="confirmLogout()">Logout</a></span>
    </li>
        </ul>
    </aside>

<main class="main">
  <div class="profile-header">
    <!-- Profile Image Preview -->
    {% if user.profile.profile_picture %}
      <img src="{{ user.profile.profile_picture.url }}" alt="Profile Picture" class="profile-img" id="current-profile-pic">
    {% else %}
      <img src="{% static 'images/profile-user.png' %}" alt="Default Profile Icon" class="profile-img" id="current-profile-pic">
    {% endif %}

    <div class="profile-info">
      <div class="username">Hello, {{ user.username }}</div>
      <span id="editProfileBtn" class="edit-picture-btn">Edit Profile Picture</span>
    </div>
  </div>

  <form method="POST" enctype="multipart/form-data" class="form-grid" action="{% url 'profile' %}">
    {% csrf_token %}

    <div class="form-group">
      <label for="first-name">First Name</label>
      <input type="text" id="first-name" name="first_name" value="{{ user.first_name }}">
    </div>

    <div class="form-group">
      <label for="last-name">Last Name</label>
      <input type="text" id="last-name" name="last_name" value="{{ user.last_name }}">
    </div>

    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" name="username" value="{{ user.username }}" readonly>
    </div>

    <div class="form-group">
      <label for="contact">Phone Number</label>
      <input type="text" id="contact" name="phone" value="{{ user.profile.contact_number }}">
    </div>

    <div class="form-group">
      <label for="email">Email Address</label>
      <input type="email" id="email" name="email" value="{{ user.email }}">
    </div>

    <div class="form-group">
      <label for="province">Province</label>
      <input type="text" id="province" name="province" value="{{ user.profile.province }}">
    </div>

    <div class="form-group">
      <label for="city">City</label>
      <input type="text" id="city" name="city" value="{{ user.profile.city }}">
    </div>

    <!-- âž• New Barangay Field -->
    <div class="form-group">
      <label for="barangay">Barangay</label>
      <input type="text" id="barangay" name="barangay" value="{{ user.profile.barangay }}">
    </div>

    <div class="form-group full-width">
      <label for="address">Specific Address</label>
      <input type="text" id="address" name="address" value="{{ user.profile.address }}">
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="id_profile_picture" name="profile_picture" accept="image/*" style="display:none;">

    <div class="form-group full-width">
      <button type="submit" class="update-btn">Update Profile</button>
    </div>
  </form>

  {% if user.is_staff %}
    <p class="text-green-600 mt-2 italic">You are an admin.</p>
  {% endif %}
</main>

</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const updateBtn = document.querySelector('.update-btn');
    const form = document.querySelector('.form-grid');
    const fields = form.querySelectorAll('input:not(#username)');
    const hiddenFileInput = document.getElementById('id_profile_picture');
    const profilePicPreview = document.getElementById('current-profile-pic');
    const editBtn = document.getElementById("editProfileBtn");

    fields.forEach(field => field.disabled = true);

    let isEditing = false;

    updateBtn.addEventListener('click', function (e) {
        e.preventDefault();

        if (!isEditing) {
            Swal.fire({
                title: 'Edit Profile?',
                text: "Do you want to enable editing for your profile?",
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'Yes, edit it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    fields.forEach(field => field.disabled = false);
                    updateBtn.textContent = 'Save Changes';
                    updateBtn.style.backgroundColor = '#28a745'; // green kapag save mode
                    isEditing = true;
                }
            });
        } else {
            Swal.fire({
                title: 'Save Changes?',
                text: "Are you sure you want to update your profile?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, save it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        }
    });

    hiddenFileInput.addEventListener('change', function () {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                profilePicPreview.src = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    document.querySelector('.edit-picture-btn')?.addEventListener('click', function () {
        hiddenFileInput.click();
    });
});
function confirmLogout() {
    Swal.fire({
        title: "Are you sure you want to logout?",
        text: "You will need to login again to access your account.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#dc3545",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Yes, Logout"
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "{% url 'logout' %}";
        }
    });
}
</script>
{% endblock %}
