{% extends 'client-base.html' %} 

{% block title %}Dashboard{% endblock %} 

{% block content %}
{% load humanize %}   
<div class="dashboard-wrapper">
    <section class="dashboard-header">
        <div class="header-top">
            <div class="dashboard-title">
                <h1>üìä Dashboard Overview</h1>
                <p>Welcome back, <strong>{{ request.user.get_full_name }}</strong>. Here‚Äôs your business summary.</p>
            </div>

            <form method="get" id="cardFilterForm" class="filter-form">
                <label><strong>Filter by:</strong></label>
                <select name="year" onchange="this.form.submit()">
                    <option value="">All Years</option>
                    {% for y in years %}
                        <option value="{{ y }}" {% if selected_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
                <select name="month" onchange="this.form.submit()">
                    <option value="">All Months</option>
                    {% for m in months %}
                        <option value="{{ m.value }}" {% if selected_month == m.value %}selected{% endif %}>{{ m.label }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="cards">
            <div class="card card-booking">
                <i class="fas fa-calendar-check"></i>
                <h3>Total Bookings</h3>
                <span>{{ booking_count }}</span>
            </div>
            <div class="card card-revenue">
                <i class="fas fa-hand-holding-usd"></i>
                <h3>Total Revenue</h3>
                <span>‚Ç±{{ revenue|intcomma }}</span>
            </div>
            <div class="card card-profit">
                <i class="fas fa-chart-line"></i>
                <h3>Total Profit</h3>
                <span>‚Ç±{{ profit|intcomma }}</span>
            </div>
            <div class="card card-pending">
                <i class="fas fa-hourglass-half"></i>
                <h3>Pending</h3>
                <span>{{ pending_count }}</span>
            </div>
            <div class="card card-rating">
                <i class="fas fa-star"></i>
                <h3>Avg Review</h3>
                <span>{{ average_rating|floatformat:1 }}</span>
            </div>
        </div>
    </section>

    <section class="quick-actions">
        <h2>‚ö° Quick Actions</h2>
        <div class="actions">
            <button onclick="location.href='{% url 'booking' %}'"><i class="fas fa-plus-circle"></i> New Booking</button>
            <button onclick="location.href='{% url 'customer' %}'"><i class="fas fa-users-cog"></i> Manage Customers</button>
        </div>
    </section>

<section class="charts-grid">
    <div class="chart-box">
        <h2>üìà Booking Status</h2>
        <p>Overview of booking progress</p>
        <canvas id="statusChart"></canvas>
        <div class="chart-summary" style="margin-top: 10px; background: #f0fdf4; border-left: 4px solid #22c55e; padding: 8px; border-radius: 4px; font-size: 0.85rem;">
            <i class="fas fa-info-circle"></i>
            <strong>Status Summary:</strong>
            <span id="statusInsightText">Focus on <b>{{ pending_count }}</b> pending bookings.</span>
        </div>
    </div>

    <div class="chart-box">
        <h2>üìÖ Monthly Trends</h2>
        <div class="month-nav">
            <button id="prevMonth" class="nav-btn">‚Äπ</button>
            <select id="monthSelect"></select>
            <button id="nextMonth" class="nav-btn">‚Ä∫</button>
        </div>
        <canvas id="monthlyChart"></canvas>
        <div class="small-meta">
            <div>Showing: <strong id="monthlyLabel">‚Äî</strong></div>
            <div class="growth">Growth: <strong id="monthlyGrowth">‚Äî</strong></div>
        </div>
        <div class="chart-summary" style="margin-top: 10px; background: #fefce8; border-left: 4px solid #eab308; padding: 8px; border-radius: 4px; font-size: 0.85rem;">
            <i class="fas fa-chart-line"></i>
            <strong>Trend:</strong> Updates based on monthly booking volume.
        </div>
    </div>

    <div class="chart-box">
        <h2>‚≠ê Feedback Analytics</h2>
        <div class="review-summary">
            <div class="review-count"><h3>Reviews</h3><p class="review-number">{{ reviews.count }}</p></div>
            <div class="average-rating"><h3>Avg. Rating</h3><p class="rating-number">{{ average_rating|default:"0" }} ‚òÖ</p></div>
        </div>
        <canvas id="feedbackChart" height="150"></canvas>
        <div class="chart-summary" style="margin-top: 10px; background: #fdf2f8; border-left: 4px solid #db2777; padding: 8px; border-radius: 4px; font-size: 0.85rem;">
            <i class="fas fa-comment-dots"></i>
            <strong>Feedback:</strong> <span id="dynamicFeedbackInsight">Select month for details.</span>
        </div>
    </div>

    <div class="chart-box full-width">
        <h2>üí∞ Revenue & Booking Analysis</h2>
        <p>Comparison of equipment earnings vs volume of bookings</p>
        <div class="chart-container" style="position: relative; height:300px;">
            <canvas id="revenueAnalysisChart"></canvas>
        </div>
        <div class="chart-summary" style="margin-top: 15px; background: #eff6ff; border-left: 4px solid #3b82f6; padding: 10px; border-radius: 4px;">
            <i class="fas fa-lightbulb"></i>
            <strong>Monthly Analysis:</strong> 
            <span id="revenueInsightText">Select a month to see performance summary.</span>
        </div>
    </div>

    <div class="chart-box full-width">
        <h2>üé∂ Popular Packages</h2>
        <canvas id="packageChart"></canvas>
        <div class="chart-summary" style="margin-top: 15px; background: #f8fafc; border-left: 4px solid #64748b; padding: 10px; border-radius: 4px;">
            <i class="fas fa-trophy"></i>
            <strong>Top Performer:</strong> <span id="topPackageText">Loading top package data...</span>
        </div>
    </div>
</section>

    <section class="feedback-events-split" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 2rem;">
        <div class="customer-feedback" style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <h2>üí¨ Latest Feedback</h2>
            {% if latest_feedback %}
                <div class="feedback-container" style="display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 15px; border-radius: 12px;">
                    <div class="feedback-comment-box">
                        <p class="comment-text">"{{ latest_feedback.comment|default:"No comment provided." }}"</p>
                        <p class="customer-name" style="font-weight: bold; color: #64748b;">‚Äî {{ latest_feedback.customer_name|default:latest_feedback.booking.full_name|default:"A Customer" }}</p>
                    </div>
                    <div class="feedback-rating-box" style="text-align: center; background: white; padding: 10px; border-radius: 10px; min-width: 80px;">
                        <h4 style="margin: 0; font-size: 0.8rem;">Rating</h4>
                        <p class="rating-stars" style="color: #f59e0b; font-weight: bold; font-size: 1.2rem; margin: 0;">{{ latest_feedback.rating|default:"0" }} ‚òÖ</p>
                    </div>
                </div>
            {% else %}
                <p>No feedback yet.</p>
            {% endif %}
        </div>

        <div class="upcoming-events" style="background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
            <h2>üìÖ Upcoming Events</h2>
            <div class="event-list">
                {% if upcoming_events %}
                    {% for event in upcoming_events %}
                        <div class="event-item" style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px; padding: 10px; background: #f8fafc; border-radius: 10px;">
                            <div class="event-date" style="background: white; padding: 8px; border-radius: 8px; text-align: center; min-width: 55px; border: 1px solid #e2e8f0;">
                                <span class="day" style="display: block; font-size: 1.2rem; font-weight: bold; color: #2563eb;">{{ event.event_date|date:"d" }}</span>
                                <span class="month" style="font-size: 0.7rem; text-transform: uppercase;">{{ event.event_date|date:"M" }}</span>
                            </div>
                            <div class="event-details">
                                <h3 style="margin: 0; font-size: 1rem;">{{ event.event_type }}</h3>
                                <p style="margin: 0; font-size: 0.85rem; color: #64748b;"><i class="fas fa-map-marker-alt"></i> {{ event.location }}</p>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No upcoming events.</p>
                {% endif %}
            </div>
        </div>
    </section>
    <style>
       /* BASE STYLES */
body { 
    background: #f1f5f9; 
    color: #1e293b; 
    margin: 0;
}

/* DASHBOARD HEADER */
.dashboard-header {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 2rem;
    background-color: #1f2937;
    border-radius: 12px;
    color: white;
}

.dashboard-title h1 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.dashboard-title p {
    font-size: 1.125rem;
    font-weight: 500;
    margin-top: 0.25rem;
    color: #e5e7eb;
}

/* FILTER FORM */
.filter-form {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
    background-color: #374151;
    padding: 0.75rem 1rem;
    border-radius: 8px;
}

.filter-form label {
    margin-right: 0.5rem;
    font-weight: 600;
    color: #f3f4f6;
}

.filter-form select {
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    background-color: #f3f4f6;
    color: #111827;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.filter-form select:hover {
    background-color: #e5e7eb;
}

.filter-form select:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

/* CARDS GRID */
.cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
    gap: 18px; 
    margin-top: 20px; 
}

.card { 
    background: white; 
    border-radius: 12px; 
    padding: 18px; 
    box-shadow: 0 6px 18px rgba(0,0,0,0.06); 
    text-align:center; 
    color: #1f2937; 
}

.card i { 
    font-size: 28px; 
    margin-bottom: 8px; 
    color: #2563eb; 
}

.card h3 { 
    font-size:14px; 
    color:#475569; 
    margin:0; 
}

.card span { 
    display:block; 
    font-size:22px; 
    font-weight:700; 
    margin-top:6px; 
    color: #000;
}

/* QUICK ACTIONS */
.quick-actions { 
    margin-top: 22px; 
    background: white; 
    padding: 16px; 
    border-radius: 12px; 
    box-shadow: 0 6px 12px rgba(0,0,0,0.06); 
}

.quick-actions .actions { 
    display:flex; 
    gap:12px; 
    flex-wrap:wrap; 
}

.quick-actions button { 
    flex:1; 
    padding:10px 14px; 
    border:none; 
    color:white; 
    background:linear-gradient(135deg,#2563eb,#3b82f6); 
    border-radius:10px; 
    cursor:pointer; 
}

/* CHARTS GRID */
.charts-grid { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 20px; 
    margin-top: 24px; 
}

.chart-box { 
    background: white; 
    padding: 20px; 
    border-radius: 12px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
    display: flex; 
    flex-direction: column;
}

.chart-summary {
    margin-top: 15px;
    padding: 10px;
    background: #f0f7ff;
    border-left: 4px solid #3b82f6;
    font-size: 13px;
    color: #1e40af;
    border-radius: 4px;
}
.chart-box.full-width { 
    grid-column: span 3; 
}

.chart-box canvas { 
    margin-top: 12px; 
    max-height: 280px; 
}

/* LEGEND */
.legend { 
    list-style:none; 
    padding:0; 
    display:flex; 
    gap:10px; 
    margin-top:10px; 
    flex-wrap:wrap; 
}

.dot { 
    width:12px; 
    height:12px; 
    border-radius:50%; 
    display:inline-block; 
    margin-right:6px; 
}

/* MONTH NAV */
.month-nav { 
    display:flex; 
    gap:8px; 
    justify-content:flex-end; 
    align-items:center; 
    margin-bottom:8px; 
}

.nav-btn { 
    background: #2563eb; 
    color:white; 
    border:none; 
    padding:6px 10px; 
    border-radius:8px; 
    cursor:pointer; 
}

.small-meta { 
    display:flex; 
    justify-content:space-between; 
    margin-top:12px; 
    color:#6b7280; 
    font-size:14px; 
}

/* CUSTOMER FEEDBACK */
.customer-feedback { 
    margin-top:20px; 
    background:white; 
    padding:18px; 
    border-radius:12px; 
    box-shadow:0 6px 12px rgba(0,0,0,0.06); 
}

.feedback-container {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 15px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    background: #f8fafc;
    flex-wrap: wrap;
}

.feedback-comment-box {
    flex: 1 1 200px;
}

.feedback-comment-box .comment-text {
    font-style: italic;
    color: #1e293b;
    margin-bottom: 5px;
}

.feedback-comment-box .customer-name {
    font-size: 14px;
    color: #64748b;
    margin: 0;
    text-align: right;
    font-weight: 500;
}

.feedback-rating-box {
    text-align: center;
    min-width: 100px;
    padding: 10px 15px;
    border-left: 3px solid #10b981;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

.feedback-rating-box h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #475569;
}

.feedback-rating-box .rating-stars {
    font-size: 24px;
    font-weight: 700;
    color: #f59e0b;
}
.feedback-insight-box {
    margin-top: 15px;
    padding: 12px;
    background: #fffbeb;
    border: 1px dashed #f59e0b;
    border-radius: 8px;
}

.feedback-insight-box h4 {
    font-size: 14px;
    color: #92400e;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.feedback-insight-box p {
    font-size: 13px;
    color: #78350f;
    margin: 0;
}
/* UPCOMING EVENTS */
.upcoming-events { 
    margin-top:20px; 
    background:white; 
    padding:14px; 
    border-radius:12px; 
    box-shadow:0 6px 12px rgba(0,0,0,0.06); 
}

.event-list { 
    display:flex; 
    flex-direction:column; 
    gap:12px; 
}

.event-item { 
    display:flex; 
    gap:12px; 
    align-items:center; 
}

.event-date { 
    width:58px; 
    height:58px; 
    background:#eef2ff; 
    border-radius:8px; 
    display:flex; 
    flex-direction:column; 
    justify-content:center; 
    align-items:center; 
    color:#111827; 
    font-weight:700; 
}

.event-date .day { 
    font-size:18px; 
    line-height:1; 
}

.event-date .month { 
    font-size:12px; 
    text-transform:uppercase; 
    color:#6b7280; 
}

/* MEDIA QUERIES FOR RESPONSIVENESS */
@media (max-width: 1080px) { 
    .charts-grid { 
        grid-template-columns: 1fr 1fr; 
    } 
    
    .chart-box.full-width { 
        grid-column: span 2; 
    } 
}

@media (max-width: 768px) { 
    .charts-grid { 
        grid-template-columns: 1fr; 
    } 
    
    .chart-box.full-width { 
        grid-column: span 1; 
    } 

    .feedback-container {
        flex-direction: column;
        align-items: stretch;
    }

    .feedback-rating-box {
        border-left: none;
        border-top: 3px solid #10b981;
        margin-top: 10px;
    }

    .filter-form {
        flex-direction: column;
        align-items: stretch;
    }
}

@media (max-width: 480px) {
    .dashboard-header {
        padding: 1rem;
        gap: 1rem;
    }

    .dashboard-title h1 {
        font-size: 1.5rem;
    }

    .dashboard-title p {
        font-size: 1rem;
    }

    .cards {
        gap: 12px;
    }

    .card span {
        font-size: 18px;
    }

    .quick-actions button {
        padding: 8px 10px;
        font-size: 14px;
    }

    .event-date {
        width: 48px;
        height: 48px;
    }

    .event-date .day {
        font-size: 16px;
    }

    .event-date .month {
        font-size: 10px;
    }
}
    </style>

<!-- Add CDN for Chart.js & plugin (as in your original) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<!-- Other canvases you already use -->
<canvas id="packageChart" style="display:none;"></canvas>
<canvas id="statusChart" style="display:none;"></canvas>
<canvas id="feedbackChart" style="display:none;"></canvas>

<script>
/* -------------------- 1. Data Initialization -------------------- */
const packagePopularityByMonth = {{ package_popularity_by_month|safe }};
const rawMonthly = {{ bookings_per_month|safe }};
const status_data_by_month = {{ status_data_by_month|safe }};
const feedback_by_month = {{ feedback_by_month|safe }};
const revenue_data_by_month = {{ revenue_data_by_month|safe }};
const notificationCount = {{ notification_count|default:0 }};

function parseMonthInput(monthVal) {
    if (!monthVal) return null;
    try {
        if (typeof monthVal === 'string') {
            const isoLike = monthVal.trim();
            if (/^\d{4}-\d{2}$/.test(isoLike)) return new Date(isoLike + '-01T00:00:00');
            const d = new Date(isoLike);
            if (!isNaN(d)) return d;
        }
    } catch (e) { return null; }
    return null;
}

const monthlyData = rawMonthly.map((item, idx) => {
    let m = item.month || item[0] || null;
    let count = item.count || item[1] || 0;
    const date = parseMonthInput(m);
    const iso = (date && !isNaN(date)) ? `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}` : m;
    const computedLabel = date && !isNaN(date) ? (date.toLocaleString('default', { month: 'short' }) + ' ' + date.getFullYear()) : iso;
    return { date, iso, label: computedLabel, count: Number(count) };
}).filter(x => x.iso).sort((a,b) => a.iso.localeCompare(b.iso));

const yearGroups = {};
monthlyData.forEach((m, i) => {
    const year = m.iso.split('-')[0];
    if (!yearGroups[year]) yearGroups[year] = [];
    yearGroups[year].push({ ...m, globalIndex: i });
});

/* -------------------- 2. Charts Initialization -------------------- */

// Revenue & Booking Analysis
const revenueAnalysisChart = new Chart(document.getElementById('revenueAnalysisChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [
        { label: 'Revenue (‚Ç±)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4, yAxisID: 'y' },
        { label: 'Bookings', type: 'bar', data: [], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 5, yAxisID: 'y1' }
    ]},
    options: { responsive: true, maintainAspectRatio: false }
});

// Monthly Trends
const monthlyChart = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'Bookings', data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.3 }] },
    options: { responsive: true, plugins: { legend: { display: false } } }
});

// ‚úÖ FIXED: Popular Packages (Blue Theme)
const packageChart = new Chart(document.getElementById('packageChart').getContext('2d'), {
    type: 'bar',
    data: { 
        labels: [], 
        datasets: [{ 
            data: [], 
            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Solid Blue
            borderColor: '#2563eb',
            borderWidth: 1,
            borderRadius: 6
        }] 
    },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        plugins: { 
            legend: { display: false } 
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Booking Status
const statusChart = new Chart(document.getElementById('statusChart').getContext('2d'), {
    type: 'doughnut',
    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#10b981','#3b82f6','#f59e0b','#ef4444'] }] },
    options: { responsive: true, cutout: '70%' }
});

// Feedback Radar
const feedbackChart = new Chart(document.getElementById('feedbackChart').getContext('2d'), {
    type: 'radar',
    data: { labels: ['Quality', 'Timeliness', 'Professionalism', 'Value'], datasets: [{ data: [], borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.2)' }] },
    options: { responsive: true, scales: { r: { min: 0, max: 5 } } }
});

/* -------------------- 3. Update & Insight Logic -------------------- */

function updateInsights(monthKey, label, idx) {
    const revInsightP = document.getElementById('revenueInsightText');
    const fbInsightP = document.getElementById('dynamicFeedbackInsight');
    const statusInsightP = document.getElementById('statusInsightText');
    const growthP = document.getElementById('monthlyGrowth');
    const topPkgP = document.getElementById('topPackageText');
    
    const rev = revenue_data_by_month[monthKey] || { total_revenue: 0 };
    const pkgs = packagePopularityByMonth[monthKey] || [];
    const fb = feedback_by_month[monthKey];
    const stats = status_data_by_month[monthKey] || [];

    // 1. Revenue Insight
    if (revInsightP) {
        revInsightP.innerHTML = `üí∞ <b>${label} Revenue:</b> ‚Ç±${rev.total_revenue.toLocaleString()}. Top Package: <b>${pkgs[0]?.package__title || 'None'}</b>.`;
    }

    // 2. Feedback Insight
    if (fbInsightP) {
        if (fb) {
            const avg = (fb.avg_quality + fb.avg_professionalism + fb.avg_timeliness + fb.avg_value_for_money) / 4;
            fbInsightP.innerHTML = `üåü Average score: <b>${avg.toFixed(1)}/5</b>. Maganda ang performance!`;
        } else {
            fbInsightP.innerHTML = "Walang feedback data sa buwan na ito.";
        }
    }

    // 3. Booking Status Insight
    if (statusInsightP) {
        const total = stats.reduce((sum, s) => sum + s.count, 0);
        const pending = stats.find(s => s.status.toLowerCase().includes('pending'))?.count || 0;
        statusInsightP.innerHTML = `Total bookings: <b>${total}</b>. Meron kang <b>${pending}</b> na kailangang i-process.`;
    }

    // 4. Monthly Growth Insight
    if (growthP) {
        if (idx > 0) {
            const prevCount = monthlyData[idx - 1].count;
            const currentCount = monthlyData[idx].count;
            if (prevCount > 0) {
                const diff = ((currentCount - prevCount) / prevCount * 100).toFixed(0);
                growthP.innerText = (diff >= 0 ? "+" : "") + diff + "% vs last month";
                growthP.style.color = diff >= 0 ? "#10b981" : "#ef4444";
            } else {
                growthP.innerText = "New Growth";
            }
        } else {
            growthP.innerText = "Baseline Month";
        }
    }

    // 5. Popular Package Insight
    if (topPkgP) {
        if (pkgs.length > 0) {
            topPkgP.innerHTML = `Ang <b>${pkgs[0].package__title}</b> ang pinakasikat na setup na may <b>${pkgs[0].count}</b> bookings.`;
        } else {
            topPkgP.innerHTML = "Walang package bookings para sa buwan na ito.";
        }
    }
}

function gotoGlobalIndex(idx) {
    if (monthlyData.length === 0) return;
    if (idx < 0) idx = 0;
    if (idx > monthlyData.length - 1) idx = monthlyData.length - 1;
    
    const selected = monthlyData[idx];
    const monthKey = selected.iso;
    const year = monthKey.split('-')[0];
    const yearMonths = yearGroups[year] || [];

    document.getElementById('monthSelect').value = idx;
    document.getElementById('monthlyLabel').innerText = selected.label;

    updateInsights(monthKey, selected.label, idx);

    // Update Revenue Chart
    revenueAnalysisChart.data.labels = yearMonths.map(m => m.label.split(' ')[0]);
    revenueAnalysisChart.data.datasets[0].data = yearMonths.map(m => (revenue_data_by_month[m.iso]?.total_revenue || 0));
    revenueAnalysisChart.data.datasets[1].data = yearMonths.map(m => m.count);
    revenueAnalysisChart.update();

    // Update Monthly Trend
    monthlyChart.data.labels = yearMonths.map(m => m.label);
    monthlyChart.data.datasets[0].data = yearMonths.map(m => m.count);
    monthlyChart.update();

    // ‚úÖ UPDATE: Popular Packages (Keep it Blue)
    const pkgData = packagePopularityByMonth[monthKey] || [];
    packageChart.data.labels = pkgData.map(p => p.package__title);
    packageChart.data.datasets[0].data = pkgData.map(p => p.count);
    // Siguraduhin na blue pa rin ang kulay pag nag-update
    packageChart.data.datasets[0].backgroundColor = 'rgba(59, 130, 246, 0.8)';
    packageChart.update();

    // Update Status
    const statData = status_data_by_month[monthKey] || [];
    statusChart.data.labels = statData.map(s => s.status);
    statusChart.data.datasets[0].data = statData.map(s => s.count);
    statusChart.update();

    // Update Feedback
    const f = feedback_by_month[monthKey] || {};
    feedbackChart.data.datasets[0].data = [f.avg_quality||0, f.avg_timeliness||0, f.avg_professionalism||0, f.avg_value_for_money||0];
    feedbackChart.update();
}

/* -------------------- 4. Initialization & Navigation -------------------- */
function init() {
    const select = document.getElementById('monthSelect');
    if(!select) return;
    select.innerHTML = '';
    Object.keys(yearGroups).sort((a,b) => b-a).forEach(y => {
        const group = document.createElement('optgroup'); group.label = y;
        yearGroups[y].forEach(m => {
            const opt = document.createElement('option'); opt.value = m.globalIndex; opt.textContent = m.label;
            group.appendChild(opt);
        });
        select.appendChild(group);
    });
    gotoGlobalIndex(monthlyData.length - 1);
}

document.getElementById('prevMonth').onclick = (e) => {
    e.preventDefault();
    gotoGlobalIndex(parseInt(document.getElementById('monthSelect').value) - 1);
};
document.getElementById('nextMonth').onclick = (e) => {
    e.preventDefault();
    gotoGlobalIndex(parseInt(document.getElementById('monthSelect').value) + 1);
};
document.getElementById('monthSelect').onchange = (e) => gotoGlobalIndex(parseInt(e.target.value));

init();
</script>


{% endblock %}