{% extends 'client-base.html' %}

{% block title %}Tracking{% endblock %}

{% block content %}
<style>
  /* Container */
  .tracking {
    margin: 30px auto;
    padding: 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  }

  .tracking h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 20px;
    color: #333;
    border-left: 6px solid #4f46e5;
    padding-left: 12px;
  }

  /* Table Styling */
  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
  }

  table th,
  table td {
    padding: 14px 18px;
    text-align: left;
  }

  table th {
    background: #f5f7fa;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 13px;
    color: #444;
  }

  table tr:nth-child(even) {
    background: #fafafa;
  }

  table td {
    font-size: 14px;
    color: #555;
    vertical-align: top;
  }

  table tr:hover {
    background: #eef2ff;
  }

  /* Equipment list */
  td ul {
    margin: 0;
    padding-left: 18px;
    list-style: disc;
    color: #444;
  }

  td p {
    margin: 0;
    font-style: italic;
    color: #777;
  }

  /* Map container */
  .map-container {
    width: 300px;
    height: 200px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    cursor: pointer;
  }

  .map-container p {
    text-align: center;
    padding-top: 50px;
    color: #777;
    font-size: 14px;
    font-style: italic;
  }

  /* Modal styling */
  .map-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
  }

  .map-modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    max-width: 90%;
    max-height: 90%;
    position: relative;
  }

  .map-modal-close {
    color: #fff;
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
  }

  .map-modal-inner {
    width: 100%;
    height: 80vh;
    min-height: 300px;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .tracking { padding: 16px; margin: 20px auto; }
    .tracking h1 { font-size: 24px; margin-bottom: 16px; }
    table th, table td { padding: 12px; font-size: 0.95rem; }
    .map-container { width: 100%; max-width: 400px; height: 220px; margin-top: 16px; }
  }

  @media (max-width: 768px) {
    .tracking { padding: 14px; margin: 16px auto; }
    .tracking h1 { font-size: 22px; padding-left: 10px; border-left-width: 5px; }
    table { display: block; overflow-x: auto; white-space: nowrap; }
    table th, table td { padding: 10px; font-size: 0.9rem; }
    td ul { padding-left: 14px; font-size: 0.9rem; }
    td p { font-size: 0.85rem; }
    .map-container { width: 100%; height: 200px; }
  }

  @media (max-width: 480px) {
    .tracking { padding: 12px; margin: 12px auto; }
    .tracking h1 { font-size: 20px; padding-left: 8px; border-left-width: 4px; }
    table th, table td { padding: 8px; font-size: 0.85rem; }
    td ul { padding-left: 12px; font-size: 0.85rem; }
    td p { font-size: 0.8rem; }
    .map-container { width: 100%; height: 180px; }
    .map-container p { font-size: 12px; padding-top: 40px; }
  }
</style>

<section class="tracking">
  <h1>Tracking Bookings</h1>
  {% if bookings %}
  <table>
    <thead>
      <tr>
        <th>Package</th>
        <th>Event Date</th>
        <th>Event Type</th>
        <th>Barangay</th>
        <th>Address</th>
        <th>Status</th>
        <th>Equipment</th>
        <th>Map</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}
      <tr>
        <td>{{ booking.package.title }}</td>
        <td>{{ booking.event_date }}</td>
        <td>{{ booking.event_type }}</td>
        <td>{{ booking.barangay }}</td>
        <td>{{ booking.fulladdress }}</td>
        <td><span style="color: #16a34a; font-weight: 600;">Approved</span></td>
        <td>
          {% if booking.package.packageequipment_set.exists %}
            <ul>
              {% for package_equipment in booking.package.packageequipment_set.all %}
                {% if package_equipment.quantity_required and package_equipment.quantity_required > 0 %}
                  <li>{{ package_equipment.equipment.name }} (x{{ package_equipment.quantity_required }})</li>
                {% endif %}
              {% endfor %}
            </ul>
          {% else %}
            <p>No equipment assigned</p>
          {% endif %}
        </td>
        <td>
          <div id="map-{{ booking.id }}" class="map-container"><p>Loading map...</p></div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No approved bookings available.</p>
  {% endif %}
</section>

<!-- Modal -->
<div id="mapModal" class="map-modal">
  <span class="map-modal-close">&times;</span>
  <div class="map-modal-content">
    <div id="modalMap" class="map-modal-inner"></div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function geocode(query, callback) {
  if (!query || query.trim() === '') { callback(false); return; }
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
    .then(res => res.json())
    .then(data => {
      if (data.length > 0) callback(true, data[0].lat, data[0].lon, query);
      else callback(false);
    })
    .catch(() => callback(false));
}

let modalMap;
const modal = document.getElementById("mapModal");
const modalMapId = "modalMap";

// Open modal map
function openModal(lat, lon, label) {
  modal.style.display = "block";

  // Clear previous map container
  const modalInner = document.getElementById(modalMapId);
  modalInner.innerHTML = '';

  // Remove old map instance
  if(modalMap) {
    modalMap.remove();
    modalMap = null;
  }

  // Initialize new map with small delay for proper sizing
  setTimeout(() => {
    modalMap = L.map(modalMapId).setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(modalMap);
    L.marker([lat, lon]).addTo(modalMap)
      .bindPopup(`<b>Barangay:</b><br>${label}`).openPopup();
    modalMap.invalidateSize();
  }, 200);
}

// Close modal
document.querySelector(".map-modal-close").onclick = function() {
  modal.style.display = "none";
  if(modalMap) { modalMap.remove(); modalMap = null; }
};
window.onclick = function(event) {
  if(event.target == modal) {
    modal.style.display = "none";
    if(modalMap) { modalMap.remove(); modalMap = null; }
  }
};

function renderMap(lat, lon, label, containerId) {
  const mapEl = document.getElementById(containerId);
  if(!mapEl) return;
  mapEl.innerHTML = '';
  setTimeout(() => {
    const map = L.map(containerId).setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.marker([lat, lon]).addTo(map)
      .bindPopup(`<b>Barangay:</b><br>${label}`).openPopup();
    map.invalidateSize();

    mapEl.onclick = () => openModal(lat, lon, label);
  }, 100);
}

// Fallback geocoding
function initMapFallback(bookingId, barangay, location, fullAddress='') {
  const containerId = 'map-' + bookingId;
  const query1 = `${barangay}, ${location}`;
  geocode(query1, function(success, lat, lon, label){
    if(success){ renderMap(lat, lon, label, containerId); return; }
    let cleaned = barangay.replace(/purok|street|st\.|area|zone|brgy\.|brgy/gi,'').trim();
    if(cleaned.length < 3) cleaned = barangay;
    const query2 = `${cleaned}, ${location}`;
    geocode(query2,function(success2, lat2, lon2, label2){
      if(success2){ renderMap(lat2, lon2, label2, containerId); return; }
      let guess='';
      if(fullAddress.length>0){ const parts = fullAddress.split(',').map(p => p.trim()); guess = parts.at(-1).replace(/purok|street|st\.|area|zone|brgy\.|brgy/gi,'').trim(); }
      if(guess){
        const query3 = `${guess}, ${location}`;
        geocode(query3,function(success3,lat3,lon3,label3){ if(success3){ renderMap(lat3, lon3, label3, containerId); return; }
          geocode(location,function(success4, lat4, lon4, label4){ if(success4){ renderMap(lat4, lon4, label4, containerId); } else { document.getElementById(containerId).innerHTML="<p>Map not available.</p>"; }}); 
        });
      } else {
        geocode(location,function(success4, lat4, lon4, label4){ if(success4){ renderMap(lat4, lon4, label4, containerId); } else { document.getElementById(containerId).innerHTML="<p>Map not available.</p>"; }}); 
      }
    });
  });
}

{% for booking in bookings %}
initMapFallback(
  '{{ booking.id }}',
  '{{ booking.barangay|escapejs }}',
  '{{ booking.location|escapejs }}',
  '{{ booking.fulladdress|escapejs }}'
);
{% endfor %}
</script>
{% endblock %}
