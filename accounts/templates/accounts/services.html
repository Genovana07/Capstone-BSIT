{% extends 'base.html' %}
{% load static %}

{% block title %}Services{% endblock %}

{% block content %}
<section class="services">
    <h2>OUR SERVICES</h2>
    <div class="title-line"></div>

    <div class="services-grid">
        {% for package in packages %}
<div class="service-item flex flex-col h-full">
    <!-- Image -->
    {% if package.image %}
        <img src="{{ package.image.url }}" alt="{{ package.title }}">
    {% else %}
        <img src="{% static 'images/package' %}{{ forloop.counter }}.png" alt="{{ package.title }}">
    {% endif %}

    <!-- Title -->
    <h3 class="package-title">{{ package.title }}</h3>

    <!-- Price -->
    <p class="package-price">Price: 
        {% if package.formatted_price %}
            {{ package.formatted_price }}
        {% else %}
            {{ package.price }}
        {% endif %}
    </p>

    <!-- Description -->
    <div class="package-desc text-sm text-gray-700 whitespace-pre-line flex-1">
        {{ package.description|linebreaksbr }}
    </div>

    <!-- Bolden Included Equipment -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".package-desc").forEach(desc => {
                desc.innerHTML = desc.innerHTML.replace("Included Equipment:", "<strong>Included Equipment:</strong>");
            });
        });
    </script>

 <!-- Button -->
    <div class="card-buttons mt-auto">
        {% if user.is_authenticated %}
            <button class="book-now w-full" onclick="confirmOpenBookingForm('{{ package.title }}')">Book Now</button>
        {% else %}
            <button class="login-first w-full" onclick="window.location.href='{% url 'login' %}'">Book Now</button>
        {% endif %}
    </div>
</div>
        <!-- Modal for Each Package -->
        <div id="modal-{{ forloop.counter }}" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal({{ forloop.counter }})">&times;</span>
                <div class="modal-body">
                    <div class="modal-image">
                        {% if package.image %}
                            <img src="{{ package.image.url }}" alt="{{ package.title }}">
                        {% else %}
                            <img src="{% static 'images/package' %}{{ forloop.counter }}.png" alt="{{ package.title }}">
                        {% endif %}
                    </div>
                    <div class="modal-details">
                        <h2>{{ package.title }}</h2>
                        <p class="modal-desc">{{ package.description }}</p>
                        <p class="modal-price"><strong>Price:</strong> 
                            {% if package.formatted_price %}
                                {{ package.formatted_price }}
                            {% else %}
                                {{ package.price }}
                            {% endif %}
                        </p>

                        <h4>Included Equipment:</h4>
                        <ul>
                            {% for pe in package.packagedequipment_set.all %}
                                <li>{{ pe.quantity_required }} Ã— {{ pe.equipment.name }}</li>
                            {% empty %}
                                <li>No equipment linked yet.</li>
                            {% endfor %}
                        </ul>

                        {% if user.is_authenticated %}
                            <button class="modal-btn book-now" onclick="confirmOpenBookingForm('{{ package.title }}')">Book Now</button>
                        {% else %}
                            <button class="modal-btn login-first" onclick="window.location.href='{% url 'login' %}'">Book Now</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Booking Form Modal -->
<div id="booking-modal" class="booking-modal">
    <div class="booking-content">
        <span class="close-btn" onclick="closeBookingForm()">&times;</span>
        <h2>Book a Service</h2>
<form method="POST" action="{% url 'create_booking' %}" id="bookingForm">
    {% csrf_token %}

    <div class="booking-form-grid">
        <div class="full-width">
            <label for="selected_package">Package Selected</label>
            <input type="text" id="selected_package" name="selected_package" readonly>
        </div>

        <div>
            <label for="full_name">Full Name</label>
            <input type="text" id="full_name" name="full_name" value="{{ user.first_name }} {{ user.last_name }}" required>
        </div>

        <div>
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" value="{{ user.email }}" required>
        </div>

        <div>
            <label for="contact_number">Contact Number</label>
            <input type="tel" id="contact_number" name="contact_number" value="{{ profile.contact_number }}" required>
        </div>

        <div>
            <label for="event_date">Event Date</label>
            <input type="date" id="event_date" name="event_date" required>
        </div>

        <div>
            <label for="event_time">Start Time</label>
            <select id="event_time" name="event_time" required>
                <option value="">Select Start Time</option>
            </select>
        </div>

        <div>
            <label for="end_time">End Time</label>
            <select id="end_time" name="end_time" required>
                <option value="">Select End Time</option>
            </select>
        </div>

        <div>
            <label for="event_type">Type of Event</label>
            <select id="event_type" name="event_type" required>
                <option value="">Select</option>
                <option value="Wedding">Wedding</option>
                <option value="Birthday">Birthday</option>
                <option value="Corporate">Corporate</option>
                <option value="Concert">Concert</option>
                <option value="Seminar">Seminar</option>
                <option value="Graduation">Graduation</option>
                <option value="Awarding Ceremony">Awarding Ceremony</option>
                <option value="Fundraising">Fundraising</option>
                <option value="Fashion Show">Fashion Show</option>
                <option value="Church">Church</option>
                <option value="Conference">Conference</option>
                <option value="School Event">School Event</option>
                <option value="Charity Event">Charity Event</option>
            </select>
        </div>

        <div>
            <label for="location">Event Location City</label>
            <input type="text" id="location" name="location" 
                   value="{{ profile.city }}" required list="city-suggestions">
            <datalist id="city-suggestions"></datalist>
        </div>

        <div class="full-width">
            <label for="fulladdress">Full Address</label>
            <input type="text" id="fulladdress" name="fulladdress" 
                   placeholder="Ex: Purok 3 Sitio Dapdap, Brgy. Dalahican, Lucena City, Quezon"
                   value="{{ profile.address }}" required>
        </div>

        <div class="full-width">
            <label for="audience_size">Expected Number of Guests</label>
            <input type="number" id="audience_size" name="audience_size" min="1" required>
        </div>
    </div>

    <button type="submit" class="submit-booking">Submit Booking Request</button>
</form>
    </div>
</div>

<!-- Toggle Script -->
<script>
function toggleDetails(counter, btn) {
    const element = document.getElementById(`details-${counter}`);
    if (element.style.display === "none") {
        element.style.display = "block";
        btn.textContent = "See Less";
    } else {
        element.style.display = "none";
        btn.textContent = "See More";
    }
}

function openModal(id) {
    document.getElementById("modal-" + id).style.display = "flex";
}
function closeModal(id) {
    document.getElementById("modal-" + id).style.display = "none";
}
window.onclick = function(event) {
    document.querySelectorAll('.modal').forEach(modal => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });
}
</script>

<!-- SweetAlert2 CSS & JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- JavaScript to handle location input -->
<script>
    // List of cities in Quezon Province
const quezonCities = [
  // District 1
  "Burdeos", "General Nakar", "Infanta", "Jomalig", "Lucban", "Mauban", "Pagbilao", "Panukulan", "Patnanungan", "Polillo", "Real", "Sampaloc", "Tayabas City",

  // District 2
  "Candelaria", "Dolores", "Lucena City", "San Antonio", "Sariaya", "Tiaong",

  // District 3
  "Agdangan", "Buenavista", "Catanauan", "General Luna", "Macalelon", "Mulanay", "Padre Burgos", "Pitogo", "San Andres", "San Francisco", "San Narciso", "Unisan",

  // District 4
  "Alabat", "Atimonan", "Calauag", "Guinayangan", "Gumaca", "Lopez", "Perez", "Plaridel", "Quezon", "Tagkawayan"
];


    // Populate the suggestions in the datalist
    const citySuggestions = document.getElementById('city-suggestions');
    quezonCities.forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        citySuggestions.appendChild(option);
    });

    // Optional: filter the suggestions based on user input
    const locationInput = document.getElementById("location");
    locationInput.addEventListener('input', function() {
        const searchTerm = locationInput.value.toLowerCase();
        const filteredCities = quezonCities.filter(city => city.toLowerCase().includes(searchTerm));

        // Clear previous suggestions
        citySuggestions.innerHTML = '';

        // Add filtered cities to suggestions
        filteredCities.forEach(city => {
            const option = document.createElement("option");
            option.value = city;
            citySuggestions.appendChild(option);
        });
    });
    function confirmOpenBookingForm(packageTitle) {
    Swal.fire({
        title: "Confirm Booking",
        text: "Do you want to book the package: " + packageTitle + "?",
        icon: "question",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, proceed",
    }).then((result) => {
        if (result.isConfirmed) {
            openBookingForm(packageTitle);
        }
    });
}

// Handle submit with SweetAlert2
document.getElementById("bookingForm").addEventListener("submit", function(e) {
    e.preventDefault(); // Stop default submit first
    
    // Isarado muna yung booking modal
    closeBookingForm();

    Swal.fire({
        title: "Submit Booking?",
        text: "Please confirm your booking request before sending.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#28a745",
        cancelButtonColor: "#d33",
        confirmButtonText: "Yes, submit",
    }).then((result) => {
        if (result.isConfirmed) {
            e.target.submit(); // Now submit form
        }
    });
});


</script>

    </div>
</div>

<footer class="footer">
    <div class="logo">
        <span style="color: white; font-weight: bold; font-size: 1.5rem;">AUDIO</span><span style="background-color: #f1c40f; color: black; font-weight: bold; padding: 2px 6px; margin-left: 4px; border-radius: 3px; font-size: 1.5rem;">MAN</span><br>
        <small style="color: white; text-transform: uppercase; font-weight: 600; letter-spacing: 1px;">Lights & Sounds</small>
        <div style="font-size: 0.7rem; color: #ddd; margin-top: 10px; text-transform: uppercase;">Owned and Operated by: Audioman Events and Entertainment Corp.</div>
    </div>
    <div class="column">
        <h3>Services</h3>
        <p>Sound System Rental</p>
        <p>Lighting Design</p>
        <p>Event Production</p>
    </div>
    <div class="column">
        <h3>Company</h3>
        <p>About Us</p>
        <p>Careers</p>
        <p>Blog</p>
    </div>
    <div class="column">
        <h3>Contact Us</h3>
        <p>info@studioflow.com</p>
        <p>+63 912 345 6789</p>
    </div>
</footer>
<div class="footer-bottom">
  Â© 2025 Audioman. All Rights Reserved.
</div>

<!-- JavaScript -->
<script>
    function toggleEquipmentVisibility(packageIndex) {
        var equipmentList = document.querySelectorAll('.service-item')[packageIndex - 1].querySelector('.equipment-list');
        if (equipmentList.style.display === "none" || equipmentList.style.display === "") {
            equipmentList.style.display = "block";
        } else {
            equipmentList.style.display = "none";
        }
    }

    function openBookingForm(packageTitle) {
        var modal = document.getElementById('booking-modal');
        var packageInput = document.getElementById('selected_package');
        packageInput.value = packageTitle;
        modal.style.display = "flex";
    }

    function closeBookingForm() {
        var modal = document.getElementById('booking-modal');
        modal.style.display = "none";
    }

    window.addEventListener("click", function (e) {
        var modal = document.getElementById('booking-modal');
        if (e.target === modal) {
            closeBookingForm();
        }
    });

    // ===============================
    // Booking Form Logic (with extended end time)
    // ===============================

    let bookingData = {};
    const allTimes = [
        "09:00", "10:00", "11:00", "12:00",
        "13:00", "14:00", "15:00", "16:00",
        "17:00", "18:00", "19:00", "20:00",
        "21:00", "22:00", "23:00", "00:00",
        "01:00", "02:00"
    ]; // extended to 2AM

    function fetchBookings() {
        fetch('/accounts/api/bookings/')
            .then(response => response.json())
            .then(data => {
                bookingData = data.form_logic;
                setupBookingFormLogic();
            });
    }

    function setupBookingFormLogic() {
        const dateInput = document.getElementById("event_date");
        const timeSelect = document.getElementById("event_time");
        const endTimeSelect = document.getElementById("end_time");

        if (!dateInput || !timeSelect || !endTimeSelect) return;

        const today = new Date().toISOString().split("T")[0];
        dateInput.setAttribute("min", today);

        dateInput.addEventListener("input", function () {
            const selectedDate = this.value;

            timeSelect.innerHTML = '<option value="">Select Start Time</option>';
            endTimeSelect.innerHTML = '<option value="">Select End Time</option>';

            const entry = bookingData[selectedDate];

            let available = [...allTimes];

            if (entry) {
                const { count, times } = entry;

                if (count >= 2) {
                    alert("This date already has two bookings. Please select another date.");
                    this.value = "";
                    return;
                }

                available = allTimes.filter(t => !times.includes(t));
                if (available.length === 0) {
                    alert("No available time slots left for this date.");
                    return;
                }
            }

            available.forEach(time => {
                const option = document.createElement("option");
                option.value = time;
                option.textContent = convertTo12Hour(time);
                timeSelect.appendChild(option);
            });

            endTimeSelect.innerHTML = '<option value="">Select End Time</option>';
        });

        timeSelect.addEventListener("change", function () {
            const start = this.value;
            const selectedDate = dateInput.value;
            endTimeSelect.innerHTML = '<option value="">Select End Time</option>';

            if (!start) return;

            const entry = bookingData[selectedDate];
            const bookedTimes = entry ? entry.times : [];

            const startIndex = allTimes.indexOf(start);
            const possibleEnds = allTimes.slice(startIndex + 1);

            const availableEnds = possibleEnds.filter(t => !bookedTimes.includes(t));

            availableEnds.forEach(endTime => {
                const option = document.createElement("option");
                option.value = endTime;
                option.textContent = convertTo12Hour(endTime);
                endTimeSelect.appendChild(option);
            });
        });
    }

    function convertTo12Hour(time24) {
        const [hour, minute] = time24.split(':');
        const h = parseInt(hour);
        const suffix = h >= 12 && h < 24 ? 'PM' : 'AM';
        const adjusted = h % 12 === 0 ? 12 : h % 12;
        return `${adjusted}:${minute} ${suffix}`;
    }

    // Initial load
    fetchBookings();
</script>



<!-- External CSS -->
<link rel="stylesheet" href="{% static 'css/services.css' %}">
<style>
.booking-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr; /* two columns */
  gap: 16px;
}

.booking-form-grid .full-width {
  grid-column: span 2; /* para sa mga field na dapat buong row */
}

.booking-modal {
    display: none;
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
}
.booking-content {
    background: white;
    max-width: 600px;
    width: 100%;
    margin: auto;
    border-radius: 10px;
    padding: 25px;
    position: relative;
    font-family: 'MavenPro', sans-serif;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}
.close-btn {
    position: absolute;
    top: 12px;
    right: 18px;
    font-size: 28px;
    cursor: pointer;
    color: #333;
}
.booking-content h2 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    color: #23194f;
}
.booking-content label {
    display: block;
    margin-top: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    color: #444;
}
.booking-content input,
.booking-content select,
.booking-content textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 0.95rem;
    margin-top: 5px;
    background-color: #f9f9f9;
    box-sizing: border-box;
}
.booking-content textarea {
    resize: vertical;
    min-height: 80px;
}
.submit-booking {
    margin-top: 25px;
    width: 100%;
    background-color: #23194f;
    color: white;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s ease;
}
.submit-booking:hover {
    background-color: #3a2d7c;
}
@media screen and (max-width: 600px) {
    .booking-content {
        padding: 20px 15px;
    }
    .booking-content h2 {
        font-size: 1.5rem;
    }
}

.see-more-btn {
    background-color: #23194f;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background 0.3s ease;
    margin-top: 10px;
    width: auto;
    display: inline-block;
}
.see-more-btn:hover {
    background-color: #3a2d7c;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}

/* Modal Box */
.modal-content {
  background: #fff;
  border-radius: 12px;
  max-width: 800px;
  width: 95%;
  padding: 20px;
  position: relative;
  animation: zoomIn 0.3s ease;
}

/* Close Button */
.close {
  position: absolute;
  top: 10px; right: 20px;
  font-size: 28px;
  font-weight: bold;
  color: #333;
  cursor: pointer;
}

/* ---------------- MODAL STYLES ---------------- */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.65);
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: #fff;
  border-radius: 16px;
  max-width: 900px;
  width: 95%;
  padding: 25px;
  position: relative;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  animation: zoomIn 0.3s ease;
}

.close {
  position: absolute;
  top: 12px; right: 18px;
  font-size: 30px;
  font-weight: bold;
  color: #555;
  cursor: pointer;
  transition: 0.2s;
}

.close:hover {
  color: #000;
}

.modal-body {
  display: flex;
  flex-wrap: wrap;
  gap: 25px;
}

.modal-image {
  flex: 1 1 40%;
  text-align: center;
}

.modal-image img {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.modal-details {
  flex: 1 1 55%;
}

.modal-details h2 {
  margin-bottom: 10px;
  font-size: 1.6rem;
  color: #333;
}

.modal-desc {
  font-size: 1rem;
  line-height: 1.5;
  margin-bottom: 10px;
  color: #555;
}

.modal-price {
  font-size: 1.1rem;
  margin-bottom: 15px;
  color: #222;
}

.modal-details ul {
  list-style: disc;
  padding-left: 20px;
  margin: 10px 0 20px;
  color: #444;
}

/* Buttons inside modal */
.modal-btn {
  display: inline-block;
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  transition: 0.3s;
}

.modal-btn.book-now {
  background: #23194f;
  color: white;
}

.modal-btn.book-now:hover {
  background: #23194f;
}

.modal-btn.login-first {
  background: #607d8b;
  color: white;
}

.modal-btn.login-first:hover {
  background: #455a64;
}
.services-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.service-item {
  background: #fff;
  border-radius: 10px;
  padding: 16px;
  display: flex;
  flex-direction: column;
  height: 100%; /* make sure lahat same height */
}

.package-desc {
  flex: 1; /* para itulak yung button pababa */
}
/* Zoom Animation */
@keyframes zoomIn {
  from { transform: scale(0.6); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
</style>

<script>
function openModal(id) {
    document.getElementById("modal-" + id).style.display = "flex";
}
function closeModal(id) {
    document.getElementById("modal-" + id).style.display = "none";
}
window.onclick = function(event) {
    document.querySelectorAll('.modal').forEach(modal => {
        if (event.target === modal) {
            modal.style.display = "none";
        }
    });
}
</script>
{% endblock %}
