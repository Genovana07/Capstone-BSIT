{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
  .container {
    display: flex;
    min-height: 100vh;
    font-family: 'MavenPro', sans-serif;
    background-color: #f9f9fb;
  }

  /* Sidebar */
  .sidebar {
    width: 240px;
    background-color: #ffffff;
    padding: 40px 20px;
    border-right: 1px solid #e0e0e0;
  }
  .sidebar ul { list-style: none; padding: 0; margin: 0; }
  .sidebar li { display: flex; align-items: center; margin-bottom: 25px; font-size: 18px; }
  .sidebar li img { width: 24px; height: 24px; margin-right: 12px; }
  .sidebar li span a {
    color: #23194f;
    font-weight: 500;
    font-size: 16px;
    text-decoration: none;
    transition: color 0.3s ease;
  }
  .sidebar li span a:hover { color: #7a3cff; }

  /* ACTIVE STATE */
  .sidebar li.active {
    background: #d9e8ff;          
    border-radius: 8px;            
    padding: 10px;
  }
  .sidebar li.active a {
    color: #1a73e8;                
    font-weight: 700;               
  }

  /* Main Content */
  .main-content {
    flex-grow: 1;
    padding: 60px;
    background-color: #fcfcff;
  }
  .main-content h2 {
    font-size: 26px;
    font-weight: 700;
    color: #1e144e;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 40px;
  }

  /* Table */
  .table-container {
    background-color: #ffffff;
    padding: 32px;
    border-radius: 16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    overflow-x: auto;
  }
  table { width: 100%; border-collapse: collapse; font-size: 15px; }
  th, td { text-align: left; padding: 16px 14px; border-bottom: 1px solid #f0f0f0; }
  th { background-color: #f4ecff; color: #23194f; font-weight: 600; text-transform: uppercase; font-size: 13px; }
  tr:hover { background-color: #faf8ff; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left:0; top:0; width:100%; height:100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background-color:white;
    padding:30px;
    border-radius:12px;
    width:450px;
    max-width:90%;
    max-height: 90vh;
    overflow-y: auto;
  }
  .modal-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-size:20px;
    font-weight:600;
    margin-bottom: 20px;
  }
  .close { font-size:24px; cursor:pointer; color:#7a3cff; }

  .form-group { margin-bottom:15px; }
  .form-group label { font-weight:600; margin-bottom:5px; display:block; }
  .form-group input, .form-group textarea {
    width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;
  }
  .form-group textarea { height:80px; }

  /* Star Rating Styles for Metrics */
  .rating-box {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 5px;
  }
  .rating-box input { display: none; }
  .rating-box label {
    font-size: 28px;
    color: #ccc;
    cursor: pointer;
    transition: color 0.2s ease;
  }
  .rating-box input:checked ~ label,
  .rating-box label:hover,
  .rating-box label:hover ~ label {
    color: #ffcc00;
  }

  /* Rate Button Styling */
  .rate-btn {
    background-color: #7a3cff;
    color: white; border: none; padding: 8px 18px; border-radius: 25px;
    font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.3s ease;
  }
  .rate-btn:hover { background-color: #5d2fcf; transform: scale(1.05); }
  .rate-btn.completed { background-color: #6c757d; cursor: not-allowed; opacity: 0.8; }

  /* Submit Button */
  .btn-submit {
    background: linear-gradient(135deg, #2563eb, #1e40af);
    color: #fff; font-size: 0.9rem; font-weight: 600; padding: 12px 16px;
    border: none; border-radius: 6px; cursor: pointer; width: 100%;
    display: inline-flex; align-items: center; justify-content: center; gap: 6px;
    transition: all 0.3s ease; margin-top: 10px;
  }
  .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.2); }

  /* Messages */
  .messages {
    display:none; position:fixed; top:20px; left:50%; transform: translateX(-50%);
    width:30%; padding:8px 15px; color:white; font-size:14px; text-align:center;
    border-radius:6px; z-index:9999;
  }
  .alert-success { background-color:#4CAF50; }
  .alert-error { background-color:#f44336; }

  /* Responsive Design */
  @media (max-width: 768px) {
    .container { flex-direction: column; }
    .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #ccc; padding: 20px; }
    .main-content { padding: 20px; }
    .modal-content { width: 95%; }
  }
</style>

<div class="container">
  <aside class="sidebar">
    <ul>
      <li class="{% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
        <img src="{% static 'images/profile-user.png' %}" alt="Profile">
        <span><a href="{% url 'profile' %}">Profile</a></span>
      </li>
      <li class="{% if request.resolver_match.url_name == 'mybookings' %}active{% endif %}">
        <img src="{% static 'images/open-book.png' %}" alt="Bookings">
        <span><a href="{% url 'mybookings' %}">My Bookings</a></span>
      </li>
      <li class="{% if request.resolver_match.url_name == 'history' %}active{% endif %}">
        <img src="{% static 'images/history.png' %}" alt="History">
        <span><a href="{% url 'history' %}">History</a></span>
      </li>
      <li>
        <img src="{% static 'images/logout.png' %}" alt="Logout">
        <span><a href="javascript:void(0);" onclick="confirmLogout()">Logout</a></span>
      </li>
    </ul>
  </aside>

  {% if messages %}
    <div class="messages" id="messageContainer">
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <main class="main-content">
    <h2><span class="icon">üïì</span> Booking History</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Customer Name</th>
            <th>Date of Booking</th>
            <th>Package Items</th>
            <th>Event Date</th>
            <th>Total Amount</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in history_list %}
            <tr>
              <td>{{ booking.customer_name }}</td>
              <td>{{ booking.date_booked }}</td>
              <td>{{ booking.package }}</td>
              <td>{{ booking.event_date }}</td>
              <td>‚Ç±{{ booking.total }}</td>
              <td>
                {% if booking.status == "Completed" %}
                  {% if booking.review_exists %}
                    <button class="rate-btn completed" disabled>Completed</button>
                  {% else %}
                    <button class="rate-btn" onclick="openModal('{{ booking.id }}', '{{ booking.customer_name }}', '{{ booking.date_booked }}', '{{ booking.package }}')">‚≠ê Rate</button>
                  {% endif %}
                {% else %}
                  <span style="color: #999;">N/A</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" style="text-align:center;">No history records found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</div>

<div id="ratingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span>Rate Your Booking</span>
      <span class="close" onclick="closeModal()">√ó</span>
    </div>
    <form id="reviewForm" method="post" action="{% url 'submit_review' %}">
      {% csrf_token %}
      <input type="hidden" id="bookingId" name="bookingId">

      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" id="customerName" readonly>
      </div>

      <div class="form-group">
        <label>Type of Event</label>
        <input type="text" id="eventType" readonly>
      </div>

      <div class="form-group">
        <label>Overall Rating</label>
        <div class="rating-box">
          {% for i in "54321" %}
          <input type="radio" id="star{{i}}" name="rating" value="{{i}}" required><label for="star{{i}}">‚òÖ</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label>Quality of Service</label>
        <div class="rating-box">
          {% for i in "54321" %}
          <input type="radio" id="q{{i}}" name="quality" value="{{i}}" required><label for="q{{i}}">‚òÖ</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label>Timeliness</label>
        <div class="rating-box">
          {% for i in "54321" %}
          <input type="radio" id="t{{i}}" name="timeliness" value="{{i}}" required><label for="t{{i}}">‚òÖ</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label>Professionalism</label>
        <div class="rating-box">
          {% for i in "54321" %}
          <input type="radio" id="p{{i}}" name="professionalism" value="{{i}}" required><label for="p{{i}}">‚òÖ</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label>Value for Money</label>
        <div class="rating-box">
          {% for i in "54321" %}
          <input type="radio" id="v{{i}}" name="value_for_money" value="{{i}}" required><label for="v{{i}}">‚òÖ</label>
          {% endfor %}
        </div>
      </div>

      <div class="form-group">
        <label for="comment">Comment</label>
        <textarea id="comment" name="comment" placeholder="Leave a comment..." required></textarea>
      </div>

      <button type="submit" class="btn-submit">
        <i class="fas fa-paper-plane"></i> Submit Review
      </button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Message Auto-hide
  document.addEventListener('DOMContentLoaded', function(){
    const msg = document.getElementById('messageContainer');
    if(msg){ msg.style.display = 'block'; setTimeout(()=>{msg.style.display='none'}, 3000);}
  });

  // Modal Control
  function openModal(bookingId, name, bookingDate, eventType) {
    document.getElementById('ratingModal').style.display = 'flex';
    document.getElementById('bookingId').value = bookingId;
    document.getElementById('customerName').value = name;
    document.getElementById('eventType').value = eventType;
    
    // Reset Form Stars and Comment
    document.getElementById('reviewForm').reset();
    document.getElementById('bookingId').value = bookingId; // Restore ID after reset
    document.getElementById('customerName').value = name;
    document.getElementById('eventType').value = eventType;
  }

  function closeModal() {
    document.getElementById('ratingModal').style.display = 'none';
  }

  // Submit Review with Confirmation
  document.getElementById('reviewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    Swal.fire({
      title: 'Submit this review?',
      text: "You won't be able to edit this later.",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2563eb',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, submit review!'
    }).then((result) => {
      if (result.isConfirmed) {
        this.submit();
      }
    });
  });

  // Logout Confirmation
  function confirmLogout() {
    Swal.fire({
      title: "Logout?",
      text: "Are you sure you want to end your session?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#7a3cff",
      confirmButtonText: "Yes, Logout"
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = "{% url 'logout' %}";
      }
    });
  }

  // Close modal when clicking background
  window.onclick = function(event) {
    let modal = document.getElementById('ratingModal');
    if (event.target == modal) closeModal();
  }
</script>
{% endblock %}